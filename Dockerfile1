FROM python:3.11-alpine AS python-builder

WORKDIR /app

RUN apk add --no-cache --update alpine-sdk
RUN apk add --no-cache gcc python3-dev musl-dev libffi-dev libc-dev

COPY Tools/mssql-proxy/odbc-driver-installer.sh Tools/mssql-proxy/requirements.txt ./

RUN ./odbc-driver-installer.sh 
RUN pip install --no-cache-dir -r requirements.txt pyinstaller

COPY Tools/mssql-proxy .

RUN pyinstaller mssql-proxy.linux.spec 

FROM alpine:latest

COPY --from=python-builder /app/dist/mssql-proxy /usr/local/bin/mssql-proxy

CMD [ "sh", "-c", "/usr/local/bin/mssql-proxy" ]